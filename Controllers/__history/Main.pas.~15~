unit Main;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics,
  Controls, Forms, uniGUITypes, uniGUIAbstractClasses,
  uniGUIClasses, uniGUIRegClasses, uniGUIForm, uniGUIBaseClasses, uniLabel,
  uniButton, unimButton, uniEdit, unimEdit, unimLabel, uniGUImJSForm, unimPanel,
  uniPanel, uniStatusBar, uniProgressBar, uniChart, uniGenericControl,
  uniBitBtn, uniMenuButton, Vcl.Menus, uniMainMenu, uniCalendar, uniTrackBar,
  uniImageList, uniTreeView, uniTreeMenu, Vcl.Imaging.pngimage, uniImage,
  uniSpeedButton, uniDateTimePicker, uniDBDateTimePicker, uniBasicGrid,
  uniDBGrid, uniDBVerticalGrid, uniDBTreeGrid, uniDBVerticalTreeGrid, uniMemo,
  uniDBMemo, uniMultiItem, uniListBox, uniDBListBox, uniDBPivotGrid;

type
  TMainForm = class(TUniForm)
    Panel_central: TUniContainerPanel;
    Panel_menu: TUniContainerPanel;
    UniContainerPanel3: TUniContainerPanel;
    UniPanel1: TUniPanel;
    TreeMenu: TUniTreeMenu;
    UniNativeImageList1: TUniNativeImageList;
    UniMenuItems1: TUniMenuItems;
    Relatrios1: TUniMenuItem;
    Metas1: TUniMenuItem;
    Produtos1: TUniMenuItem;
    UniLabel2: TUniLabel;
    UniLabel3: TUniLabel;
    UniLabel4: TUniLabel;
    Panel_resumo: TUniSimplePanel;
    UniPanel3: TUniPanel;
    UniImage1: TUniImage;
    UniLabel1: TUniLabel;
    UniLabel6: TUniLabel;
    UniPanel2: TUniPanel;
    UniImage2: TUniImage;
    UniLabel7: TUniLabel;
    UniLabel8: TUniLabel;
    UniPanel4: TUniPanel;
    UniImage3: TUniImage;
    UniLabel9: TUniLabel;
    UniLabel10: TUniLabel;
    UniLabel12: TUniLabel;
    UniProgressBar1: TUniProgressBar;
    UniLabel5: TUniLabel;
    UniLabel13: TUniLabel;
    UniPanel6: TUniPanel;
    UniLabel14: TUniLabel;
    UniDBGrid2: TUniDBGrid;
    icketMdio1: TUniMenuItem;
    UniImage4: TUniImage;
    UniLabel11: TUniLabel;
    UniButton1: TUniButton;
    UniDateTimePicker1: TUniDateTimePicker;
    procedure UniLabel2Click(Sender: TObject);
    procedure UniFormShow(Sender: TObject);
    procedure UniButton1Click(Sender: TObject);
    procedure icketMdio1Click(Sender: TObject);
  private
    procedure Atualiza_dados;
    { Private declarations }
  public
    { Public declarations }
  end;

function MainForm: TMainForm;

implementation

{$R *.dfm}

uses
  uniGUIVars, MainModule, uniGUIApplication, ServerModule, U_ticket_medio;

function MainForm: TMainForm;
begin
  Result := TMainForm(Frm_MainModule.GetFormInstance(TMainForm));
end;

procedure TMainForm.icketMdio1Click(Sender: TObject);
begin
// chamada de ticket médio
 // TFrm_ticket_medio.Create(UniApplication);
  Frm_ticket_medio.ShowModalN;
end;

procedure TMainForm.UniButton1Click(Sender: TObject);
begin
  Atualiza_dados;
end;

procedure TMainForm.UniFormShow(Sender: TObject);
begin
  Atualiza_dados;
  Frm_MainModule.carrega_dados_conexao;
  UniLabel5.Caption:= Frm_MainModule.loja_logada;
  UniLabel4.Caption:= 'Olá, '+Frm_MainModule.usuario_conectado;
  UniPanel6.Left:= Round(Panel_central.Width/2) - Round(UniPanel6.Width/2);
end;

procedure TMainForm.UniLabel2Click(Sender: TObject);
begin
  TreeMenu.Micro:= not(TreeMenu.Micro);
  if TreeMenu.Micro then begin
    Panel_menu.Width:= 44;
  end else begin
    Panel_menu.Width:= 281;
  end;
end;

PRocedure TMainForm.Atualiza_dados();
begin
  UniServerModule.ADOConnection1.Connected:= True;

  UniServerModule.ADOQuery_dados.Close;
  UniServerModule.ADOQuery_dados.SQL.Clear;
  UniServerModule.ADOQuery_dados.SQL.Add('select cast(sum(sai_tot)as float)as venda from sai_mt_cab where sai_dt = '+chr(39)+UniDateTimePicker1.text+chr(39)+' and cl_canc is null');
  UniServerModule.ADOQuery_dados.Open;

  UniLabel9.Caption:= FormatCurr('R$ ###,##0.00',UniServerModule.ADOQuery_dados.FieldByName('venda').AsCurrency);

  UniServerModule.ADOQuery_dados.Close;
  UniServerModule.ADOQuery_dados.SQL.Clear;
  UniServerModule.ADOQuery_dados.SQL.Add('select cast(sum(sai_tot)as float)as total from sai_mt_cab '+
                                          'where sai_dt between ''2022-09-01'' and '+chr(39)+UniDateTimePicker1.text+chr(39)+' and cl_canc is null');
  UniServerModule.ADOQuery_dados.Open;
  UniLabel7.Caption:=  FormatCurr('R$ ###,##0.00',UniServerModule.ADOQuery_dados.FieldByName('total').AsCurrency);
  UniProgressBar1.Position:=  Round(UniServerModule.ADOQuery_dados.FieldByName('total').AsInteger);


  UniServerModule.ADOQuery_ranking.Close;
  UniServerModule.ADOQuery_ranking.SQL.Clear;
  UniServerModule.ADOQuery_ranking.SQL.Add('SELECT CL_NOME, SUM(SAI_TOT) AS TOTAL '+
                                            'FROM SAI_MT_CAB CAB INNER JOIN CAD_CL CL '+
                                            'ON CAB.CL_ID = CL.CL_ID '+
                                            'WHERE CL_CANC IS NULL AND '+
                                            '    SAI_DT BETWEEN ''2022-09-01'' AND ''2022-09-30'''+//+chr(39)+UniDateTimePicker1.text+chr(39)+
                                            ' GROUP BY CL_NOME ORDER BY SUM(SAI_TOT) DESC ');
  UniServerModule.ADOQuery_ranking.Open;

//UniServerModule.ADOConnection1.Connected:= False;

  end;

initialization
  RegisterAppFormClass(TMainForm);

end.
