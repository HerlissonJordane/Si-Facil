unit U_metas_loja;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics,
  Controls, Forms, uniGUITypes, uniGUIAbstractClasses,
  uniGUIClasses, uniGUIForm, uniEdit, uniCalendar, uniDateTimePicker, uniLabel,
  uniGUIBaseClasses, uniPanel, uniProgressBar, uniButton, DateUtils,
  uniMultiItem, uniListBox, uniComboBox, uniDBComboBox, uniSpinEdit, Data.DB,
  Data.Win.ADODB;

type
  TFrm_metas_loja = class(TUniForm)
    UniPanel1: TUniPanel;
    UniLabel1: TUniLabel;
    Button_buscar: TUniButton;
    UniPanel2: TUniPanel;
    ProgressBar_meta: TUniProgressBar;
    UniLabel2: TUniLabel;
    UniEdit_meta: TUniEdit;
    UniLabel4: TUniLabel;
    UniButton2: TUniButton;
    Button_gravar: TUniButton;
    UniButton4: TUniButton;
    UniLabel5: TUniLabel;
    Label_total: TUniLabel;
    ComboBox_mes: TUniComboBox;
    SpinEdit_ano: TUniSpinEdit;
    ADOQuery_meta: TADOQuery;
    ADOQuery_vendas: TADOQuery;
    Label_meta: TUniLabel;
    procedure UniButton4Click(Sender: TObject);
    procedure UniFormShow(Sender: TObject);
    procedure Button_buscarClick(Sender: TObject);
    procedure UniButton2Click(Sender: TObject);
    procedure Button_gravarClick(Sender: TObject);
  private
    function BuscaVendasMetas(data: TDate): Double;
    { Private declarations }
  public
    { Public declarations }
  end;

function Frm_metas_loja: TFrm_metas_loja;

implementation

{$R *.dfm}

uses
  MainModule, uniGUIApplication, ServerModule;

function Frm_metas_loja: TFrm_metas_loja;
begin
  Result := TFrm_metas_loja(Frm_MainModule.GetFormInstance(TFrm_metas_loja));
end;

procedure TFrm_metas_loja.Button_buscarClick(Sender: TObject);
var total_vendas: Double;
    data: String;
begin
  ADOQuery_meta.Close;
  ADOQuery_meta.SQL.Clear;
  ADOQuery_meta.SQL.Add('select top 1(mdt_metareal2) from tab_mdt '+
                        'where mdt_mes = '+chr(39)+IntToStr(ComboBox_mes.ItemIndex)+chr(39)+
                        ' and mdt_ano = '+chr(39)+IntToStr(SpinEdit_ano.Value)+chr(39)+
                        ' and lj_id = 2020');
  ADOQuery_meta.Open;

  UniLabel2.Caption:= 'Meta atual do mês de '+ ComboBox_mes.Text;


  data:= '01/'+IntToStr(ComboBox_mes.ItemIndex)+'/'+IntToStr(SpinEdit_ano.Value);
  total_vendas:= BuscaVendasMetas(StrToDate(data));

  if ADOQuery_meta.FieldByName('mdt_metareal2').AsString = '' then begin
    UniEdit_meta.Text:= 'Nenhuma meta registrada nesse mês';
    ProgressBar_meta.Max:=0;
    ProgressBar_meta.Position:= 0;
    ProgressBar_meta.Text:= 'Sem meta cadastrada nesse mês';
    Label_meta.Caption:= '';
  end else begin
    UniEdit_meta.Text:= FormatCurr('R$ ###,##0.00',ADOQuery_meta.FieldByName('mdt_metareal2').AsCurrency);
    ProgressBar_meta.Max:= Round(ADOQuery_meta.FieldByName('mdt_metareal2').AsInteger);
    ProgressBar_meta.Position:=  Round(total_vendas);
    Label_meta.Caption:= UniEdit_meta.Text;
  end;
  Label_total.Caption:= FormatCurr('R$ ###,##0.00',total_vendas)

end;

procedure TFrm_metas_loja.Button_gravarClick(Sender: TObject);
begin
  UniEdit_meta.ReadOnly:= True;
  Button_gravar.Enabled:= False;

  ADOQuery_meta.Close;
  ADOQuery_meta.SQL.Clear;
  ADOQuery_meta.SQL.Add();
  ADOQuery_meta.Open;
end;

procedure TFrm_metas_loja.UniButton2Click(Sender: TObject);
begin
  if MonthOf(Date) = ComboBox_mes.ItemIndex then begin
    //deixa alterar
    UniEdit_meta.ReadOnly:= False;
    Button_gravar.Enabled:= True;
  end else begin
    ShowMessageN('Não é permitido alterar meta de datas anteriores.');
    Abort;
  end;
end;

procedure TFrm_metas_loja.UniButton4Click(Sender: TObject);
begin
  Close;
end;

procedure TFrm_metas_loja.UniFormShow(Sender: TObject);
begin
  //UniEdit1.Text:= DateToStr(date);
  UniEdit_meta.Text:= 'R$ 150.350';
  ComboBox_mes.ItemIndex:= MonthOf(Date);
  SpinEdit_ano.Value:= YearOf(Date);

  try
    Button_buscar.Click;
  except on E: Exception do
    ShowMessage('Erro ao carregar os dados');
  end;
end;

function TFrm_metas_loja.BuscaVendasMetas(data: TDate): Double;
var data_inicio, data_final: STring;
begin

  //data_inicio:= IntToStr(ano)+'-'+mes+'-'+'01';
  data_inicio:=  DateToStr(StartofTheMonth(data));
  data_final:=  DateToStr(EndofTheMonth(data));
  ADOQuery_vendas.Close;
  ADOQuery_vendas.SQL.Clear;
  ADOQuery_vendas.SQL.Add('select cast(sum(sai_tot)as float)as total from sai_mt_cab '+
                          'where sai_dt between '+chr(39)+data_inicio+chr(39)+' and '
                          +chr(39)+ data_final+chr(39)+' and cl_canc is null');
  ADOQuery_vendas.Open;
  Result:= ADOQuery_vendas.FieldByName('total').AsFloat;
end;

end.
